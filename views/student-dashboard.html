<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - Mess Feedback System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --glass-bg: rgba(255, 255, 255, 0.25);
            --glass-border: rgba(255, 255, 255, 0.18);
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 25px 50px rgba(0, 0, 0, 0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-attachment: fixed;
            min-height: 100vh;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="75" cy="75" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="50" cy="10" r="0.5" fill="rgba(255,255,255,0.05)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            pointer-events: none;
            z-index: -1;
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
            position: relative;
        }

        .sidebar {
            width: 300px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--glass-border);
            padding: 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            z-index: 1000;
        }

        .logo-section {
            text-align: center;
            padding: 2rem;
            background: var(--primary-gradient);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .logo-section::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        .logo {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            color: white;
            font-size: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 2;
        }

        .nav-menu {
            padding: 2rem 0;
        }

        .nav-item {
            display: block;
            padding: 1.2rem 2rem;
            color: var(--text-primary);
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
            margin: 0.5rem 1rem;
            border-radius: 0 15px 15px 0;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--primary-gradient);
            transition: all 0.3s ease;
            z-index: -1;
        }

        .nav-item:hover::before,
        .nav-item.active::before {
            left: 0;
        }

        .nav-item:hover,
        .nav-item.active {
            color: white;
            border-left-color: #fff;
            transform: translateX(5px);
        }

        .nav-item i {
            margin-right: 1rem;
            width: 20px;
            font-size: 1.1rem;
        }

        .main-content {
            flex: 1;
            margin-left: 300px;
            padding: 2rem;
            position: relative;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 25px;
            padding: 2.5rem;
            text-align: center;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: all 0.6s ease;
        }

        .stat-card:hover {
            transform: translateY(-10px);
            box-shadow: var(--shadow-xl);
        }

        .stat-card:hover::before {
            left: 100%;
        }

        .stat-icon {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 2rem;
            color: white;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .stat-number {
            font-size: 3rem;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 1.1rem;
        }

        .content-section {
            display: none;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 25px;
            padding: 3rem;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        .content-section.active {
            display: block;
            animation: fadeInUp 0.6s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .content-section h2 {
            color: var(--text-primary);
            font-weight: 700;
            margin-bottom: 2rem;
            font-size: 2.2rem;
            position: relative;
        }

        .content-section h2::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 0;
            width: 60px;
            height: 4px;
            background: var(--primary-gradient);
            border-radius: 2px;
        }

        .menu-display {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: var(--shadow-lg);
        }

        .menu-item-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 1.5rem;
            margin: 1rem 0;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border-left: 4px solid var(--primary-gradient);
        }

        .menu-item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        .food-item {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .food-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.12);
        }

        .food-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .star-rating {
            display: flex;
            gap: 0.3rem;
            margin: 1rem 0;
            justify-content: center;
        }

        .star {
            font-size: 1.8rem;
            color: #e2e8f0;
            cursor: pointer;
            transition: all 0.2s ease;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .star:hover,
        .star.active {
            color: #ffd700;
            transform: scale(1.1);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .form-control {
            width: 100%;
            padding: 1.2rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
            transform: translateY(-2px);
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
            padding: 1.2rem 2.5rem;
            border: none;
            border-radius: 15px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: all 0.6s ease;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        .alert {
            padding: 1.5rem;
            border-radius: 15px;
            margin: 1.5rem 0;
            border: none;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            font-weight: 500;
        }

        .alert-success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
        }

        .alert-error {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
        }

        .logout-btn {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: var(--secondary-gradient);
            color: white;
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(245, 87, 108, 0.3);
            z-index: 1001;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(245, 87, 108, 0.4);
        }

        .nav-notification-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--secondary-gradient);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.6rem;
            display: none;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            animation: pulse 2s infinite;
        }

        .nav-notification-badge.show {
            display: flex;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .notification-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 450px;
            max-height: 600px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            box-shadow: var(--shadow-medium);
            z-index: 1001;
            display: none;
            animation: modalFadeIn 0.3s ease-out;
        }

        .notification-panel::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: -1;
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .notification-panel.show {
            display: block;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .notification-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-header h5 {
            color: white;
            margin: 0;
            font-weight: 600;
        }

        .notification-list {
            max-height: 400px;
            overflow-y: auto;
            padding: 1rem;
        }

        .notification-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-left: 4px solid;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .notification-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }

        .notification-item.info {
            border-left-color: #36A2EB;
        }

        .notification-item.success {
            border-left-color: #4BC0C0;
        }

        .notification-item.warning {
            border-left-color: #FFCE56;
        }

        .notification-item.error {
            border-left-color: #FF6384;
        }

        .notification-message {
            color: white;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .notification-admin {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 0.3rem;
        }

        .notification-time {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
        }

        .no-notifications {
            text-align: center;
            padding: 2rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .no-notifications i {
            font-size: 2rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .meal-time-message {
            margin: 1rem 0;
        }

        .meal-time-message .alert {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 1rem;
            color: white;
            margin-bottom: 1rem;
        }

        .meal-time-message .alert.alert-success {
            background: rgba(67, 233, 123, 0.2);
            border-color: rgba(67, 233, 123, 0.3);
        }

        .meal-time-message .alert.alert-info {
            background: rgba(54, 162, 235, 0.2);
            border-color: rgba(54, 162, 235, 0.3);
        }

        .meal-time-message .alert.alert-warning {
            background: rgba(255, 193, 7, 0.2);
            border-color: rgba(255, 193, 7, 0.3);
        }

        .meal-time-message .alert i {
            margin-right: 0.5rem;
        }

        /* Mobile Responsiveness */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 1rem;
            left: 1rem;
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 12px;
            width: 50px;
            height: 50px;
            cursor: pointer;
            z-index: 1003;
            box-shadow: 0 5px 15px rgba(67, 233, 123, 0.3);
            transition: all 0.3s ease;
        }

        .mobile-menu-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(67, 233, 123, 0.4);
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        /* Mobile Styles */
        @media (max-width: 768px) {
            .dashboard-container {
                flex-direction: column;
            }

            .sidebar {
                position: fixed;
                top: 0;
                left: -300px;
                width: 280px;
                height: 100vh;
                z-index: 1000;
                transition: left 0.3s ease;
                overflow-y: auto;
            }

            .sidebar.show {
                left: 0;
            }

            .sidebar-overlay.show {
                display: block;
            }

            .main-content {
                margin-left: 0;
                padding: 1rem;
                width: 100%;
                min-height: 100vh;
            }

            .mobile-menu-btn {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .logout-btn {
                top: 1rem;
                right: 1rem;
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
            }

            .notification-panel {
                width: 90%;
                max-width: 350px;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
                gap: 1rem;
            }

            .stat-card {
                padding: 1.5rem;
            }

            .stat-number {
                font-size: 2rem;
            }

            .content-section {
                padding: 1.5rem;
                margin-bottom: 1rem;
            }

            .form-row {
                flex-direction: column;
            }

            .form-row .form-group {
                margin-bottom: 1rem;
            }

            .meal-time-message .alert {
                padding: 1rem;
                font-size: 0.9rem;
            }
        }

        /* Tablet Styles */
        @media (max-width: 1024px) and (min-width: 769px) {
            .sidebar {
                width: 220px;
            }

            .main-content {
                margin-left: 220px;
                padding: 1.5rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1.5rem;
            }

            .notification-panel {
                width: 380px;
            }
        }

        /* Small Mobile Styles */
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .stat-card {
                padding: 1rem;
            }

            .content-section {
                padding: 1rem;
                border-radius: 15px;
            }

            .content-section h2 {
                font-size: 1.5rem;
            }

            .notification-panel {
                width: 95%;
                max-height: 70vh;
            }

            .logout-btn {
                padding: 0.5rem 0.8rem;
                font-size: 0.8rem;
            }

            .mobile-menu-btn {
                width: 45px;
                height: 45px;
            }
        }

        .history-item {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 2rem;
            margin: 1.5rem 0;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--primary-gradient);
            transition: all 0.3s ease;
        }

        .history-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        .rating-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .rating-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .food-item-rating {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border-left: 4px solid var(--primary-gradient);
            transition: all 0.3s ease;
        }

        .food-item-rating:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.12);
        }

        .food-emoji {
            font-size: 2rem;
            margin-right: 1rem;
        }

        .food-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
        }

        .btn-lg {
            padding: 1.5rem 3rem;
            font-size: 1.2rem;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: relative;
                height: auto;
            }
            
            .main-content {
                margin-left: 0;
                padding: 1rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Mobile Menu Button -->
        <button class="mobile-menu-btn" id="mobileMenuBtn">
            <i class="fas fa-bars"></i>
        </button>

        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <div class="sidebar" id="sidebar">
            <div class="logo-section">
                <div class="logo"><i class="fas fa-utensils"></i></div>
                <h3>Mess Feedback</h3>
                <p id="welcomeText">Welcome, Student!</p>
            </div>
            <nav class="nav-menu">
                <a href="#" class="nav-item active" onclick="showSection('dashboard')">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
                <a href="#" class="nav-item" onclick="showSection('profile')">
                    <i class="fas fa-user"></i> My Profile
                </a>
                <a href="#" class="nav-item" onclick="showSection('feedback')">
                    <i class="fas fa-star"></i> Give Feedback
                </a>
                <a href="#" class="nav-item" onclick="showSection('complaint')">
                    <i class="fas fa-exclamation-triangle"></i> Lodge Complaint
                </a>
                <a href="#" class="nav-item" onclick="toggleNotifications()">
                    <i class="fas fa-bell"></i> Notifications
                    <span class="nav-notification-badge" id="navNotificationBadge">0</span>
                </a>
                <a href="#" class="nav-item" onclick="showSection('history')">
                    <i class="fas fa-history"></i> My History
                </a>
            </nav>
        </div>

        <div class="main-content">
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>

            <!-- AI Chat Panel -->
            <div class="notification-panel" id="aiChatPanel" style="width: 500px; max-height: 700px;">
                <div class="notification-header">
                    <h5><i class="fas fa-robot me-2"></i>AI Assistant</h5>
                    <button class="btn-close" onclick="toggleAIChat()"></button>
                </div>
                <div class="notification-list" id="aiChatMessages" style="max-height: 450px; overflow-y: auto; padding: 1rem;">
                    <div class="text-center" style="color: rgba(255,255,255,0.7); padding: 2rem;">
                        <i class="fas fa-robot" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <p>Hello! I'm your AI assistant. How can I help you today?</p>
                        <p style="font-size: 0.85rem; margin-top: 1rem;">Ask me about:</p>
                        <ul style="text-align: left; font-size: 0.85rem; list-style: none; padding: 0;">
                            <li>• How to give feedback</li>
                            <li>• Mess menu information</li>
                            <li>• Lodging complaints</li>
                            <li>• Points and rewards</li>
                        </ul>
                    </div>
                </div>
                <div style="padding: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="aiChatInput" placeholder="Type your message..." 
                            style="flex: 1; padding: 0.75rem; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: white;"
                            onkeypress="if(event.key === 'Enter') sendAIMessage()">
                        <button onclick="sendAIMessage()" 
                            style="padding: 0.75rem 1.5rem; border-radius: 10px; border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; cursor: pointer;">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div id="aiChatStatus" style="margin-top: 0.5rem; font-size: 0.75rem; color: rgba(255,255,255,0.6); text-align: center;"></div>
                </div>
            </div>

            <!-- Notification Panel -->
            <div class="notification-panel" id="notificationPanel">
                <div class="notification-header">
                    <h5><i class="fas fa-bell me-2"></i>Notifications</h5>
                    <button class="btn-close" onclick="toggleNotifications()"></button>
                </div>
                <div class="notification-list" id="notificationList">
                    <div class="no-notifications">
                        <i class="fas fa-bell-slash"></i>
                        <p>No notifications yet</p>
                    </div>
                </div>
            </div>

            <!-- Dashboard Section -->
            <div id="dashboard" class="content-section active">
                <h2>Dashboard Overview</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <i class="fas fa-coins"></i>
                        </div>
                        <div class="stat-number" id="totalPoints">0</div>
                        <div class="stat-label">Total Points</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="stat-number" id="totalFeedback">0</div>
                        <div class="stat-label">Feedback Given</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%);">
                            <i class="fas fa-exclamation-circle"></i>
                        </div>
                        <div class="stat-number" id="totalComplaints">0</div>
                        <div class="stat-label">Complaints Lodged</div>
                    </div>
                </div>
                
                <!-- Notifications Section -->
                <div class="notifications-section" style="margin-top: 30px;">
                    <h3><i class="fas fa-bell me-2"></i>Recent Notifications</h3>
                    <div id="notificationsContainer" style="background: rgba(255,255,255,0.1); border-radius: 15px; padding: 20px; max-height: 300px; overflow-y: auto;">
                        <div id="notificationsList">
                            <div class="text-center" style="color: #ccc; padding: 20px;">
                                <i class="fas fa-bell-slash fa-2x mb-3"></i>
                                <p>Loading notifications...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Section -->
            <div id="profile" class="content-section">
                <h2><i class="fas fa-user me-3"></i>My Profile</h2>
                <div id="profileAlert"></div>
                <form id="profileForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label><i class="fas fa-user me-2"></i>Full Name</label>
                                <input type="text" id="fullName" class="form-control" placeholder="Enter your full name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label><i class="fas fa-envelope me-2"></i>Email</label>
                                <input type="email" id="email" class="form-control" placeholder="Enter your email" required>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label><i class="fas fa-phone me-2"></i>Phone Number</label>
                                <input type="tel" id="phone" class="form-control" placeholder="Enter your phone number">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label><i class="fas fa-id-card me-2"></i>Student ID</label>
                                <input type="text" id="studentId" class="form-control" placeholder="Enter your student ID">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label><i class="fas fa-building me-2"></i>Department</label>
                                <select id="department" class="form-control" required>
                                    <option value="">Select Department</option>
                                    <option value="CSE">Computer Science Engineering</option>
                                    <option value="ECE">Electronics & Communication</option>
                                    <option value="EEE">Electrical & Electronics</option>
                                    <option value="MECH">Mechanical Engineering</option>
                                    <option value="CIVIL">Civil Engineering</option>
                                    <option value="IT">Information Technology</option>
                                    <option value="OTHER">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label><i class="fas fa-graduation-cap me-2"></i>Year of Study</label>
                                <select id="yearOfStudy" class="form-control" required>
                                    <option value="">Select Year</option>
                                    <option value="1">1st Year</option>
                                    <option value="2">2nd Year</option>
                                    <option value="3">3rd Year</option>
                                    <option value="4">4th Year</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label><i class="fas fa-home me-2"></i>Hostel Name</label>
                                <select id="hostelName" class="form-control">
                                    <option value="">Select Hostel</option>
                                    <option value="Boys Hostel A">Boys Hostel A</option>
                                    <option value="Boys Hostel B">Boys Hostel B</option>
                                    <option value="Girls Hostel A">Girls Hostel A</option>
                                    <option value="Girls Hostel B">Girls Hostel B</option>
                                    <option value="Day Scholar">Day Scholar</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label><i class="fas fa-door-open me-2"></i>Room Number</label>
                                <input type="text" id="roomNumber" class="form-control" placeholder="Enter room number (if applicable)">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label><i class="fas fa-utensils me-2"></i>Dietary Preferences</label>
                                <select id="dietaryPreferences" class="form-control">
                                    <option value="">Select Preference</option>
                                    <option value="Vegetarian">Vegetarian</option>
                                    <option value="Non-Vegetarian">Non-Vegetarian</option>
                                    <option value="Vegan">Vegan</option>
                                    <option value="Jain">Jain Food</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label><i class="fas fa-exclamation-triangle me-2"></i>Allergies</label>
                                <input type="text" id="allergies" class="form-control" placeholder="Enter any food allergies (optional)">
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-4">
                        <button type="submit" class="btn-primary btn-lg px-5">
                            <i class="fas fa-save me-2"></i>Update Profile
                        </button>
                    </div>
                </form>
            </div>

            <!-- Feedback Section -->
            <div id="feedback" class="content-section">
                <h2><i class="fas fa-star me-3"></i>Give Feedback</h2>
                <div id="feedbackAlert"></div>
                
                <div id="todayMenu" class="menu-display">
                    <h3><i class="fas fa-calendar-day me-2"></i>Today's Menu</h3>
                    <div id="menuContent">Loading menu...</div>
                </div>

                <form id="feedbackForm">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-bold"><i class="fas fa-building me-2"></i>Mess Hall</label>
                            <select id="messHall" class="form-control" required onchange="loadMealItems()">
                                <option value="">Loading mess halls...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold"><i class="fas fa-clock me-2"></i>Meal Type</label>
                            <select id="mealType" class="form-control" required onchange="loadMealItems()">
                                <option value="">Loading meal types...</option>
                            </select>
                        </div>
                    </div>

                    <div id="foodItemsSection" style="display: none;">
                        <h4 class="mb-4"><i class="fas fa-utensils me-2"></i>Rate Individual Food Items</h4>
                        <div id="foodItemsList"></div>
                    </div>

                    <div id="generalRatingsSection" style="display: none;">
                        <h4 class="mb-4"><i class="fas fa-chart-line me-2"></i>General Ratings</h4>
                        <div class="row">
                            <div class="col-md-4 mb-4">
                                <div class="rating-card p-3">
                                    <label class="form-label fw-bold text-center d-block">
                                        <i class="fas fa-concierge-bell me-2"></i>Service Quality
                                    </label>
                                    <div class="star-rating justify-content-center" data-rating="service">
                                        <span class="star" data-value="1">★</span>
                                        <span class="star" data-value="2">★</span>
                                        <span class="star" data-value="3">★</span>
                                        <span class="star" data-value="4">★</span>
                                        <span class="star" data-value="5">★</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-4">
                                <div class="rating-card p-3">
                                    <label class="form-label fw-bold text-center d-block">
                                        <i class="fas fa-broom me-2"></i>Cleanliness
                                    </label>
                                    <div class="star-rating justify-content-center" data-rating="cleanliness">
                                        <span class="star" data-value="1">★</span>
                                        <span class="star" data-value="2">★</span>
                                        <span class="star" data-value="3">★</span>
                                        <span class="star" data-value="4">★</span>
                                        <span class="star" data-value="5">★</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-4">
                                <div class="rating-card p-3">
                                    <label class="form-label fw-bold text-center d-block">
                                        <i class="fas fa-music me-2"></i>Ambience
                                    </label>
                                    <div class="star-rating justify-content-center" data-rating="ambience">
                                        <span class="star" data-value="1">★</span>
                                        <span class="star" data-value="2">★</span>
                                        <span class="star" data-value="3">★</span>
                                        <span class="star" data-value="4">★</span>
                                        <span class="star" data-value="5">★</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label class="form-label fw-bold"><i class="fas fa-comments me-2"></i>Overall Comments</label>
                                <textarea id="overallComments" class="form-control" rows="4" placeholder="Share your overall experience and feedback..."></textarea>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold"><i class="fas fa-lightbulb me-2"></i>Suggestions</label>
                                <textarea id="suggestions" class="form-control" rows="4" placeholder="Any suggestions for improvement..."></textarea>
                            </div>
                        </div>

                        <div class="text-center">
                            <button type="submit" class="btn-primary btn-lg px-5">
                                <i class="fas fa-paper-plane me-2"></i>Submit Feedback
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Complaint Section -->
            <div id="complaint" class="content-section">
                <h2>Lodge Complaint</h2>
                <div id="complaintAlert"></div>
                <form id="complaintForm">
                    <div class="form-group">
                        <label>Complaint Type</label>
                        <select id="complaintType" class="form-control" required>
                            <option value="">Select Type</option>
                            <option value="food_quality">Food Quality</option>
                            <option value="service">Service</option>
                            <option value="cleanliness">Cleanliness</option>
                            <option value="hygiene">Hygiene</option>
                            <option value="staff_behavior">Staff Behavior</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="complaintTitle" class="form-control" placeholder="Brief description of the issue" required>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="complaintDescription" class="form-control" rows="5" placeholder="Detailed description of your complaint..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label>Severity</label>
                        <select id="complaintSeverity" class="form-control" required>
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                    <button type="submit" class="btn-primary">Submit Complaint</button>
                </form>
            </div>

            <!-- History Section -->
            <div id="history" class="content-section">
                <h2>My History</h2>
                <div id="historyContent">
                    <h3>Feedback History</h3>
                    <div id="feedbackHistory">Loading...</div>
                    <h3>Complaint History</h3>
                    <div id="complaintHistory">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentRatings = {};
        let currentUser = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Get user from localStorage
            const userData = localStorage.getItem('user');
            const token = localStorage.getItem('token');
            
            if (!userData || !token) {
                window.location.href = '/student-login';
                return;
            }
            
            currentUser = JSON.parse(userData);
            console.log('Current user:', currentUser);
            
            loadProfile();
            loadStats();
            loadTodayMenu();
            loadHistory();
            initializeStarRatings();
            loadNotifications();
            loadCurrentMealTime();
            loadMessHalls();
            loadMealTypes();
            
            // Load notifications every 30 seconds
            setInterval(loadNotifications, 30000);
            
            // Check meal time every 5 minutes
            setInterval(loadCurrentMealTime, 300000);
        });

        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');
        }

        async function loadProfile() {
            try {
                if (!currentUser) return;
                
                // Update welcome text with current user
                document.getElementById('welcomeText').textContent = `Welcome, ${currentUser.username}!`;
                
                const response = await fetch('/api/user/profile', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const profile = result.profile;
                    
                    // Load all profile fields
                    document.getElementById('fullName').value = profile.fullName || '';
                    document.getElementById('email').value = profile.email || '';
                    document.getElementById('phone').value = profile.phone || '';
                    document.getElementById('studentId').value = profile.studentId || '';
                    document.getElementById('department').value = profile.department || '';
                    document.getElementById('yearOfStudy').value = profile.yearOfStudy || '';
                    document.getElementById('hostelName').value = profile.hostelName || '';
                    document.getElementById('roomNumber').value = profile.roomNumber || '';
                    document.getElementById('dietaryPreferences').value = profile.dietaryPreferences || '';
                    document.getElementById('allergies').value = profile.allergies || '';
                } else {
                    console.error('Failed to load profile');
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                // Fallback to show username
                if (currentUser) {
                    document.getElementById('welcomeText').textContent = `Welcome, ${currentUser.username}!`;
                }
            }
        }

        async function loadMessHalls() {
            try {
                const response = await fetch('/api/mess-halls');
                const result = await response.json();
                
                const messHallSelect = document.getElementById('messHall');
                messHallSelect.innerHTML = '<option value="">Select Mess Hall</option>';
                
                if (result.success && result.messHalls) {
                    result.messHalls.forEach(messHall => {
                        const option = document.createElement('option');
                        option.value = messHall.name;
                        option.textContent = `🏢 ${messHall.name}`;
                        messHallSelect.appendChild(option);
                    });
                } else {
                    // Fallback options
                    messHallSelect.innerHTML = `
                        <option value="">Select Mess Hall</option>
                        <option value="North Campus Mess">🏢 North Campus Mess</option>
                        <option value="South Campus Mess">🏢 South Campus Mess</option>
                    `;
                }
            } catch (error) {
                console.error('Error loading mess halls:', error);
                // Fallback options
                const messHallSelect = document.getElementById('messHall');
                messHallSelect.innerHTML = `
                    <option value="">Select Mess Hall</option>
                    <option value="North Campus Mess">🏢 North Campus Mess</option>
                    <option value="South Campus Mess">🏢 South Campus Mess</option>
                `;
            }
        }

        async function loadMealTypes() {
            try {
                const response = await fetch('/api/meal-types');
                const result = await response.json();
                
                const mealTypeSelect = document.getElementById('mealType');
                mealTypeSelect.innerHTML = '<option value="">Select Meal Type</option>';
                
                if (result.success && result.mealTypes) {
                    const mealEmojis = {
                        'breakfast': '🌅',
                        'lunch': '☀️',
                        'dinner': '🌙',
                        'snacks': '🍪'
                    };
                    
                    result.mealTypes.forEach(mealType => {
                        const option = document.createElement('option');
                        option.value = mealType.name;
                        const emoji = mealEmojis[mealType.name] || '🍽️';
                        option.textContent = `${emoji} ${mealType.display_name}`;
                        mealTypeSelect.appendChild(option);
                    });
                } else {
                    // Fallback options
                    mealTypeSelect.innerHTML = `
                        <option value="">Select Meal Type</option>
                        <option value="breakfast">🌅 Breakfast</option>
                        <option value="lunch">☀️ Lunch</option>
                        <option value="dinner">🌙 Dinner</option>
                        <option value="snacks">🍪 Snacks</option>
                    `;
                }
            } catch (error) {
                console.error('Error loading meal types:', error);
                // Fallback options
                const mealTypeSelect = document.getElementById('mealType');
                mealTypeSelect.innerHTML = `
                    <option value="">Select Meal Type</option>
                    <option value="breakfast">🌅 Breakfast</option>
                    <option value="lunch">☀️ Lunch</option>
                    <option value="dinner">🌙 Dinner</option>
                    <option value="snacks">🍪 Snacks</option>
                `;
            }
        }

        async function loadStats() {
            try {
                if (!currentUser) return;
                
                const response = await fetch(`/api/dashboard/stats?userId=${currentUser.id}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const stats = await response.json();
                
                document.getElementById('totalPoints').textContent = stats.totalPoints;
                document.getElementById('totalFeedback').textContent = stats.totalFeedback;
                document.getElementById('totalComplaints').textContent = stats.totalComplaints;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        let currentMenuData = null;

        async function loadTodayMenu() {
            try {
                const response = await fetch('/api/menu/today');
                const menuData = await response.json();
                currentMenuData = menuData;
                
                const menuContent = document.getElementById('menuContent');
                menuContent.innerHTML = `
                    <div class="menu-item-card">
                        <h4><i class="fas fa-calendar me-2"></i>${menuData.day.charAt(0).toUpperCase() + menuData.day.slice(1)} - ${menuData.date}</h4>
                        <p><strong><i class="fas fa-clock me-2"></i>Current Meal: ${menuData.currentMeal.charAt(0).toUpperCase() + menuData.currentMeal.slice(1)}</strong></p>
                        <p><i class="fas fa-utensils me-2"></i>${menuData.currentMealItems}</p>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading menu:', error);
            }
        }

        function loadMealItems() {
            const mealType = document.getElementById('mealType').value;
            const messHall = document.getElementById('messHall').value;
            const foodItemsSection = document.getElementById('foodItemsSection');
            const generalRatingsSection = document.getElementById('generalRatingsSection');
            const foodItemsList = document.getElementById('foodItemsList');

            console.log('loadMealItems called:', { mealType, messHall, currentMenuData });

            if (!mealType || !currentMenuData) {
                console.log('Missing mealType or currentMenuData');
                foodItemsSection.style.display = 'none';
                generalRatingsSection.style.display = 'none';
                return;
            }

            // Handle new menu structure from database
            let mealItems = '';
            if (currentMenuData.menu) {
                // Try to get items for selected mess hall and meal type
                const selectedMessHall = messHall || 'North Campus Mess'; // Default to North Campus
                
                if (currentMenuData.menu[selectedMessHall] && currentMenuData.menu[selectedMessHall][mealType]) {
                    mealItems = currentMenuData.menu[selectedMessHall][mealType];
                } else if (currentMenuData.menu['North Campus Mess'] && currentMenuData.menu['North Campus Mess'][mealType]) {
                    // Fallback to North Campus Mess
                    mealItems = currentMenuData.menu['North Campus Mess'][mealType];
                } else {
                    // Fallback to currentMealItems if available
                    mealItems = currentMenuData.currentMealItems || 'Tea, Biscuits, Samosa, Banana';
                }
            } else {
                // Old structure fallback
                mealItems = currentMenuData[mealType] || currentMenuData.currentMealItems || 'Tea, Biscuits, Samosa, Banana';
            }

            console.log('Found meal items:', mealItems);
            
            if (!mealItems) {
                console.log('No meal items found');
                foodItemsSection.style.display = 'none';
                generalRatingsSection.style.display = 'none';
                return;
            }

            // Handle both array and string formats
            const foodItems = Array.isArray(mealItems) ? mealItems : mealItems.split(', ');

            const foodEmojis = {
                'Poori': '🫓', 'Rava Kitchadi': '🍚', 'Coconut Chutney': '🥥', 'Coffee': '☕',
                'Pongal': '🍚', 'Semiya Kitchadi': '🍜', 'Kara Chutney': '🌶️',
                'White Rice': '🍚', 'Raw Banana Varuval': '🍌', 'Brinjal Masala': '🍆',
                'Buttermilk': '🥛', 'Paruppu Thovaiyal': '🫘', 'Pickle': '🥒',
                'Idly': '⚪', 'Dosa': '🥞', 'Sambar': '🍲', 'Tea': '🍵',
                'Bread Jam': '🍞', 'Vada': '🟤', 'Chicken': '🍗', 'Biryani': '🍛',
                'Chappathi': '🫓', 'Parota': '🥞', 'Halwa': '🍮', 'Cake': '🍰',
                'Biscuits': '🍪', 'Samosa': '🥟', 'Banana': '🍌', 'Cookies': '🍪',
                'Mixture': '🥜', 'Apple': '🍎', 'Filter': '☕'
            };

            let foodItemsHTML = '';
            foodItems.forEach((item, index) => {
                const cleanItem = item.trim();
                const emoji = foodEmojis[cleanItem.split(' ')[0]] || '🍽️';
                
                foodItemsHTML += `
                    <div class="food-item-rating">
                        <div class="food-title">
                            <span class="food-emoji">${emoji}</span>
                            ${cleanItem}
                        </div>
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <div class="star-rating" data-rating="food-${index}">
                                    <span class="star" data-value="1">★</span>
                                    <span class="star" data-value="2">★</span>
                                    <span class="star" data-value="3">★</span>
                                    <span class="star" data-value="4">★</span>
                                    <span class="star" data-value="5">★</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <input type="text" class="form-control" placeholder="Comment (optional)" 
                                       id="comment-${index}" style="font-size: 0.9rem;">
                            </div>
                        </div>
                    </div>
                `;
            });

            foodItemsList.innerHTML = foodItemsHTML;
            foodItemsSection.style.display = 'block';
            generalRatingsSection.style.display = 'block';

            // Re-initialize star ratings for new food items
            initializeStarRatings();
        }

        async function loadHistory() {
            try {
                if (!currentUser) return;
                
                console.log('Loading history for user ID:', currentUser.id);
                
                const response = await fetch(`/api/dashboard/history?userId=${currentUser.id}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const history = await response.json();
                console.log('History data:', history);
                
                const feedbackHistory = document.getElementById('feedbackHistory');
                const complaintHistory = document.getElementById('complaintHistory');
                
                // Display feedback history
                if (history.feedback && history.feedback.length > 0) {
                    feedbackHistory.innerHTML = history.feedback.map(item => `
                        <div class="history-item" style="background: rgba(255,255,255,0.1); padding: 15px; margin: 10px 0; border-radius: 10px; border-left: 4px solid #4CAF50;">
                            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 8px;">
                                <h4 style="margin: 0; color: #fff;">
                                    <i class="fas fa-star me-2"></i>${item.meal_type || 'Feedback'} - ${item.mess_hall || 'Mess Hall'}
                                </h4>
                                <small style="color: #ddd;">${new Date(item.created_at).toLocaleDateString()}</small>
                            </div>
                            <div style="margin: 8px 0;">
                                <span style="background: #4CAF50; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem;">
                                    <i class="fas fa-coins me-1"></i>+${item.points_earned} points
                                </span>
                            </div>
                            <div style="display: flex; gap: 15px; margin: 8px 0; font-size: 0.9rem;">
                                ${item.service_rating ? `<span><i class="fas fa-concierge-bell me-1"></i>Service: ${item.service_rating}/5</span>` : ''}
                                ${item.cleanliness_rating ? `<span><i class="fas fa-broom me-1"></i>Cleanliness: ${item.cleanliness_rating}/5</span>` : ''}
                                ${item.ambience_rating ? `<span><i class="fas fa-music me-1"></i>Ambience: ${item.ambience_rating}/5</span>` : ''}
                            </div>
                            ${item.overall_comments ? `<p style="margin: 8px 0; font-style: italic;">"${item.overall_comments}"</p>` : ''}
                            ${item.suggestions ? `<p style="margin: 8px 0; color: #FFD700;"><i class="fas fa-lightbulb me-1"></i><strong>Suggestion:</strong> ${item.suggestions}</p>` : ''}
                        </div>
                    `).join('');
                } else {
                    feedbackHistory.innerHTML = '<p style="text-align: center; color: #ccc; padding: 20px;"><i class="fas fa-star me-2"></i>No feedback submitted yet.</p>';
                }
                
                // Display complaint history
                if (history.complaints && history.complaints.length > 0) {
                    complaintHistory.innerHTML = history.complaints.map(item => {
                        const statusColor = item.status === 'open' ? '#FF9800' : 
                                          item.status === 'in_progress' ? '#2196F3' : 
                                          item.status === 'resolved' ? '#4CAF50' : '#9E9E9E';
                        
                        return `
                            <div class="history-item" style="background: rgba(255,255,255,0.1); padding: 15px; margin: 10px 0; border-radius: 10px; border-left: 4px solid ${statusColor};">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <h4 style="margin: 0; color: #fff;">
                                        <i class="fas fa-exclamation-triangle me-2"></i>${item.title}
                                    </h4>
                                    <small style="color: #ddd;">${new Date(item.created_at).toLocaleDateString()}</small>
                                </div>
                                <div style="margin: 8px 0;">
                                    <span style="background: ${statusColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem;">
                                        ${item.status_display || item.status}
                                    </span>
                                    <span style="background: rgba(255,255,255,0.2); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; margin-left: 8px;">
                                        ${item.complaint_type}
                                    </span>
                                    <span style="background: rgba(255,255,255,0.2); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; margin-left: 8px;">
                                        ${item.severity} priority
                                    </span>
                                </div>
                                <p style="margin: 8px 0; color: #ddd;">${item.description}</p>
                                ${item.incident_date ? `<small style="color: #bbb;"><i class="fas fa-calendar me-1"></i>Incident Date: ${new Date(item.incident_date).toLocaleDateString()}</small>` : ''}
                            </div>
                        `;
                    }).join('');
                } else {
                    complaintHistory.innerHTML = '<p style="text-align: center; color: #ccc; padding: 20px;"><i class="fas fa-exclamation-triangle me-2"></i>No complaints submitted yet.</p>';
                }
            } catch (error) {
                console.error('Error loading history:', error);
                document.getElementById('feedbackHistory').innerHTML = '<p style="color: #ff6b6b;">Error loading feedback history.</p>';
                document.getElementById('complaintHistory').innerHTML = '<p style="color: #ff6b6b;">Error loading complaint history.</p>';
            }
        }

        function initializeStarRatings() {
            document.querySelectorAll('.star-rating').forEach(rating => {
                const stars = rating.querySelectorAll('.star');
                const ratingType = rating.getAttribute('data-rating');
                
                stars.forEach((star, index) => {
                    star.addEventListener('click', () => {
                        const value = parseInt(star.getAttribute('data-value'));
                        currentRatings[ratingType] = value;
                        
                        stars.forEach((s, i) => {
                            if (i < value) {
                                s.classList.add('active');
                            } else {
                                s.classList.remove('active');
                            }
                        });
                    });
                });
            });
        }

        // Form submissions
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentUser) return;
            
            const formData = {
                fullName: document.getElementById('fullName').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                studentId: document.getElementById('studentId').value,
                department: document.getElementById('department').value,
                yearOfStudy: document.getElementById('yearOfStudy').value,
                hostelName: document.getElementById('hostelName').value,
                roomNumber: document.getElementById('roomNumber').value,
                dietaryPreferences: document.getElementById('dietaryPreferences').value,
                allergies: document.getElementById('allergies').value
            };
            
            console.log('Submitting profile data:', formData);
            
            try {
                const response = await fetch('/api/user/profile', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                console.log('Profile update response:', result);
                
                if (result.success) {
                    document.getElementById('profileAlert').innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>Profile updated successfully!</div>';
                } else {
                    document.getElementById('profileAlert').innerHTML = '<div class="alert alert-error"><i class="fas fa-exclamation-triangle me-2"></i>Failed to update profile: ' + (result.message || 'Unknown error') + '</div>';
                }
            } catch (error) {
                console.error('Profile update error:', error);
                document.getElementById('profileAlert').innerHTML = '<div class="alert alert-error"><i class="fas fa-exclamation-triangle me-2"></i>Error updating profile. Please try again.</div>';
            }
        });

        document.getElementById('feedbackForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            console.log('Form submission started!'); // Debug log
            
            const mealType = document.getElementById('mealType').value;
            const messHall = document.getElementById('messHall').value;
            
            console.log('Selected values:', { mealType, messHall }); // Debug log
            
            // Check if meal type and mess hall are selected
            if (!mealType) {
                document.getElementById('feedbackAlert').innerHTML = '<div class="alert alert-error"><i class="fas fa-exclamation-triangle me-2"></i>Please select a meal type.</div>';
                return;
            }
            
            if (!messHall) {
                document.getElementById('feedbackAlert').innerHTML = '<div class="alert alert-error"><i class="fas fa-exclamation-triangle me-2"></i>Please select a mess hall.</div>';
                return;
            }
            
            // Skip duplicate check - let the server handle it
            
            // Collect food item ratings and comments
            const itemRatings = {};
            const itemComments = {};
            
            // Get all food item ratings
            document.querySelectorAll('[data-rating^="food-"]').forEach(ratingDiv => {
                const ratingType = ratingDiv.getAttribute('data-rating');
                const itemIndex = ratingType.split('-')[1];
                const rating = currentRatings[ratingType];
                const comment = document.getElementById(`comment-${itemIndex}`)?.value || '';
                
                if (rating) {
                    itemRatings[`item_${itemIndex}`] = rating;
                    itemComments[`item_${itemIndex}`] = comment;
                }
            });
            
            // Collect general ratings
            const commonRatings = {
                service: currentRatings.service || 0,
                cleanliness: currentRatings.cleanliness || 0,
                ambience: currentRatings.ambience || 0
            };
            
            console.log('Current ratings object:', currentRatings);
            console.log('Item ratings collected:', itemRatings);
            console.log('Common ratings collected:', commonRatings);
            
            // Check if at least one rating is provided
            const hasItemRatings = Object.keys(itemRatings).length > 0;
            const hasCommonRatings = commonRatings.service > 0 || commonRatings.cleanliness > 0 || commonRatings.ambience > 0;
            
            if (!hasItemRatings && !hasCommonRatings) {
                document.getElementById('feedbackAlert').innerHTML = '<div class="alert alert-error"><i class="fas fa-exclamation-triangle me-2"></i>Please provide at least one rating before submitting.</div>';
                return;
            }
            
            // Calculate overall rating as average of all ratings
            const allRatings = [
                commonRatings.service,
                commonRatings.cleanliness,
                commonRatings.ambience,
                ...Object.values(itemRatings)
            ].filter(r => r > 0);
            
            const overallRating = allRatings.length > 0 
                ? Math.round(allRatings.reduce((a, b) => a + b, 0) / allRatings.length)
                : 0;
            
            const formData = {
                mess_hall_id: parseInt(document.getElementById('messHall').value) || 1,
                meal_type: mealType,
                overall_rating: overallRating,
                service_rating: commonRatings.service || null,
                cleanliness_rating: commonRatings.cleanliness || null,
                value_rating: commonRatings.ambience || null,
                overall_comments: document.getElementById('overallComments').value || '',
                item_ratings: Object.entries(itemRatings).map((entry, idx) => ({
                    menu_item_id: idx + 1,
                    rating: entry[1],
                    comment: itemComments[entry[0]] || ''
                })),
                is_anonymous: false
            };
            
            console.log('Submitting feedback:', formData); // Debug log
            
            // Disable submit button and show loading
            const submitButton = document.querySelector('#feedbackForm button[type="submit"]');
            const originalText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Submitting...';
            
            try {
                const response = await fetch('/api/feedback/submit', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(formData)
                });
                
                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Feedback response:', result); // Debug log
                
                if (result.success) {
                    document.getElementById('feedbackAlert').innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>Feedback submitted successfully! Thank you for your valuable feedback.</div>';
                    
                    // Reset form completely
                    document.getElementById('feedbackForm').reset();
                    document.getElementById('messHall').selectedIndex = 0;
                    document.getElementById('mealType').selectedIndex = 0;
                    document.getElementById('foodItemsSection').style.display = 'none';
                    document.getElementById('generalRatingsSection').style.display = 'none';
                    document.getElementById('overallComments').value = '';
                    document.getElementById('suggestions').value = '';
                    
                    // Clear all ratings
                    currentRatings = {};
                    document.querySelectorAll('.star').forEach(star => {
                        star.classList.remove('active');
                        star.style.color = '#ddd';
                    });
                    
                    // Clear all comment fields
                    document.querySelectorAll('input[id^="comment-"]').forEach(input => {
                        input.value = '';
                    });
                    
                    // Reload data
                    loadStats();
                    loadHistory();
                    loadCurrentMealTime(); // Refresh meal restrictions
                    
                    // Scroll to top of feedback section
                    document.getElementById('feedback').scrollIntoView({ behavior: 'smooth' });
                } else {
                    document.getElementById('feedbackAlert').innerHTML = `<div class="alert alert-error"><i class="fas fa-exclamation-triangle me-2"></i>Failed to submit feedback: ${result.message}</div>`;
                }
            } catch (error) {
                console.error('Feedback submission error:', error);
                document.getElementById('feedbackAlert').innerHTML = '<div class="alert alert-error"><i class="fas fa-exclamation-triangle me-2"></i>Error submitting feedback. Please try again.</div>';
            } finally {
                // Re-enable submit button
                submitButton.disabled = false;
                submitButton.innerHTML = originalText;
            }
        });

        document.getElementById('complaintForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentUser) return;
            
            const type = document.getElementById('complaintType').value;
            const title = document.getElementById('complaintTitle').value;
            const description = document.getElementById('complaintDescription').value;
            const severity = document.getElementById('complaintSeverity').value;
            
            // Validation
            if (!type || !title || !description || !severity) {
                document.getElementById('complaintAlert').innerHTML = '<div class="alert alert-error"><i class="fas fa-exclamation-triangle me-2"></i>Please fill in all required fields.</div>';
                return;
            }
            
            const formData = {
                complaint_type: type,
                title: title,
                description: description,
                severity: severity,
                mess_hall_id: 1
            };
            
            console.log('Submitting complaint:', formData);
            console.log('Current user:', currentUser);
            
            // Disable submit button and show loading
            const submitButton = document.querySelector('#complaintForm button[type="submit"]');
            const originalText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Submitting...';
            
            try {
                const response = await fetch('/api/complaints', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(formData)
                });
                
                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Complaint response:', result);
                
                if (result.success) {
                    document.getElementById('complaintAlert').innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>Complaint submitted successfully! We will review it shortly.</div>';
                    
                    // Reset form
                    document.getElementById('complaintForm').reset();
                    document.getElementById('complaintType').selectedIndex = 0;
                    
                    // Reload data
                    loadStats();
                    loadHistory();
                    
                    // Scroll to top of complaint section
                    document.getElementById('complaint').scrollIntoView({ behavior: 'smooth' });
                } else {
                    document.getElementById('complaintAlert').innerHTML = `<div class="alert alert-error"><i class="fas fa-exclamation-triangle me-2"></i>Failed to submit complaint: ${result.message || 'Unknown error'}</div>`;
                }
            } catch (error) {
                console.error('Complaint submission error:', error);
                document.getElementById('complaintAlert').innerHTML = '<div class="alert alert-error"><i class="fas fa-exclamation-triangle me-2"></i>Error submitting complaint. Please try again.</div>';
            } finally {
                // Re-enable submit button
                submitButton.disabled = false;
                submitButton.innerHTML = originalText;
            }
        });

        // Notification Functions
        async function loadNotifications() {
            if (!currentUser) return;
            
            try {
                const response = await fetch(`/api/notifications/${currentUser.username}`);
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        displayNotifications(result.notifications);
                        updateNotificationBadge(result.notifications);
                        displayDashboardNotifications(result.notifications);
                    }
                } else {
                    // Show sample notifications if endpoint doesn't exist
                    displayDashboardNotifications([
                        {
                            id: 1,
                            title: "Welcome to Mess Feedback System",
                            message: "Start giving feedback to earn points!",
                            type: "info",
                            created_at: new Date().toISOString(),
                            is_read: false
                        },
                        {
                            id: 2,
                            title: "Feedback Rewards",
                            message: "Earn 10 points for each feedback submission!",
                            type: "success",
                            created_at: new Date(Date.now() - 86400000).toISOString(),
                            is_read: false
                        }
                    ]);
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
                // Show sample notifications on error
                displayDashboardNotifications([
                    {
                        id: 1,
                        title: "System Notification",
                        message: "Welcome to the Mess Feedback System! Submit feedback to earn points.",
                        type: "info",
                        created_at: new Date().toISOString(),
                        is_read: false
                    }
                ]);
            }
        }
        
        function displayDashboardNotifications(notifications) {
            const notificationsList = document.getElementById('notificationsList');
            
            if (!notifications || notifications.length === 0) {
                notificationsList.innerHTML = `
                    <div class="text-center" style="color: #ccc; padding: 20px;">
                        <i class="fas fa-bell-slash fa-2x mb-3"></i>
                        <p>No notifications yet</p>
                    </div>
                `;
                return;
            }
            
            // Show latest 5 notifications
            const recentNotifications = notifications.slice(0, 5);
            
            notificationsList.innerHTML = recentNotifications.map(notification => {
                const typeColors = {
                    'info': '#2196F3',
                    'success': '#4CAF50',
                    'warning': '#FF9800',
                    'error': '#f44336'
                };
                
                const typeIcons = {
                    'info': 'fas fa-info-circle',
                    'success': 'fas fa-check-circle',
                    'warning': 'fas fa-exclamation-triangle',
                    'error': 'fas fa-times-circle'
                };
                
                const priorityColors = {
                    'urgent': '#f44336',
                    'high': '#FF9800',
                    'normal': '#2196F3'
                };
                
                const color = typeColors[notification.type] || '#2196F3';
                const icon = typeIcons[notification.type] || 'fas fa-bell';
                const timeAgo = getTimeAgo(new Date(notification.created_at));
                const priorityColor = priorityColors[notification.priority] || '#2196F3';
                
                // Calculate days until expiry
                const expiryDate = new Date(notification.expires_at);
                const now = new Date();
                const daysLeft = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));
                
                return `
                    <div class="notification-item" style="
                        background: rgba(255,255,255,0.05); 
                        border-radius: 12px; 
                        padding: 16px; 
                        margin-bottom: 12px; 
                        border-left: 4px solid ${color};
                        ${notification.is_read ? 'opacity: 0.7;' : ''}
                        cursor: pointer;
                        transition: all 0.3s ease;
                    " onclick="markNotificationAsRead(${notification.id})" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='rgba(255,255,255,0.05)'">
                        <div style="display: flex; align-items: flex-start; gap: 12px;">
                            <div style="color: ${color}; font-size: 1.3rem; margin-top: 2px;">
                                <i class="${icon}"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px;">
                                    <h5 style="margin: 0; color: #fff; font-size: 1rem; font-weight: 600;">
                                        ${notification.title}
                                    </h5>
                                    <div style="display: flex; gap: 6px; align-items: center;">
                                        ${notification.priority && notification.priority !== 'normal' ? `
                                            <span style="background: ${priorityColor}; color: white; padding: 2px 6px; border-radius: 8px; font-size: 0.7rem; font-weight: 600;">
                                                ${(notification.priority || 'normal').toUpperCase()}
                                            </span>
                                        ` : ''}
                                        ${!notification.is_read ? `
                                            <div style="width: 8px; height: 8px; background: ${color}; border-radius: 50%;"></div>
                                        ` : ''}
                                    </div>
                                </div>
                                <p style="margin: 0 0 10px 0; color: #ddd; font-size: 0.9rem; line-height: 1.5;">
                                    ${notification.message}
                                </p>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="display: flex; gap: 15px; font-size: 0.75rem; color: #bbb;">
                                        <span><i class="fas fa-user me-1"></i>From: ${notification.sender_name || 'System'}</span>
                                        <span><i class="fas fa-clock me-1"></i>${timeAgo}</span>
                                        ${daysLeft > 0 ? `<span><i class="fas fa-hourglass-half me-1"></i>Expires in ${daysLeft} days</span>` : ''}
                                    </div>
                                    ${!notification.is_read ? `
                                        <small style="color: ${color}; font-weight: 600;">
                                            <i class="fas fa-circle me-1" style="font-size: 0.5rem;"></i>New
                                        </small>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Mark notification as read
        async function markNotificationAsRead(notificationId) {
            try {
                const response = await fetch(`/api/notifications/${notificationId}/read`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    // Reload notifications to update read status
                    loadNotifications();
                }
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }
        
        function getTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
            if (diffInSeconds < 2592000) return `${Math.floor(diffInSeconds / 86400)}d ago`;
            return date.toLocaleDateString();
        }

        function displayNotifications(notifications) {
            const notificationList = document.getElementById('notificationList');
            
            // Handle undefined or non-array notifications
            if (!notifications || !Array.isArray(notifications) || notifications.length === 0) {
                notificationList.innerHTML = `
                    <div class="no-notifications">
                        <i class="fas fa-bell-slash"></i>
                        <p>No notifications yet</p>
                    </div>
                `;
                return;
            }
            
            notificationList.innerHTML = notifications.map(notification => `
                <div class="notification-item ${notification.type}" onclick="markAsRead(${notification.id})">
                    <div class="notification-message">${notification.message}</div>
                    <div class="notification-admin">From: ${notification.adminName || 'Admin'}</div>
                    <div class="notification-time">${formatTimeAgo(new Date(notification.timestamp))}</div>
                </div>
            `).join('');
        }

        function updateNotificationBadge(notifications) {
            const badge = document.getElementById('navNotificationBadge');
            // Handle undefined or non-array notifications
            if (!notifications || !Array.isArray(notifications)) {
                badge.textContent = '0';
                badge.classList.remove('show');
                return;
            }
            const unreadCount = notifications.filter(n => !n.read).length;
            
            badge.textContent = unreadCount;
            if (unreadCount > 0) {
                badge.classList.add('show');
            } else {
                badge.classList.remove('show');
            }
        }

        function toggleNotifications() {
            const panel = document.getElementById('notificationPanel');
            panel.classList.toggle('show');
            
            // If showing panel, load latest notifications
            if (panel.classList.contains('show')) {
                loadNotifications();
            }
        }

        async function markAsRead(notificationId) {
            try {
                const response = await fetch(`/api/notifications/${notificationId}/read`, {
                    method: 'PUT'
                });
                
                if (response.ok) {
                    loadNotifications(); // Refresh notifications
                }
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }

        function formatTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} minutes ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} hours ago`;
            return `${Math.floor(diffInSeconds / 86400)} days ago`;
        }

        // Load Current Meal Time and Apply Restrictions
        async function loadCurrentMealTime() {
            try {
                // Get current meal time
                const mealTimeResponse = await fetch('/api/current-meal-time');
                const mealTimeData = await mealTimeResponse.json();
                
                // Get daily submissions
                const dailyResponse = await fetch(`/api/daily-submissions/${currentUser.id || 1}`);
                const dailyData = await dailyResponse.json();
                
                // Handle both old and new API response formats
                const allowedMeals = mealTimeData.allowedMeals || ['breakfast', 'lunch', 'dinner'];
                const remainingMeals = dailyData.data?.remainingMeals || dailyData.remainingMeals || ['breakfast', 'lunch', 'dinner'];
                
                if (allowedMeals && Array.isArray(allowedMeals) && remainingMeals && Array.isArray(remainingMeals)) {
                    // Combine restrictions: only meals that are both time-allowed AND not submitted today
                    const availableMeals = allowedMeals.filter(meal => 
                        remainingMeals.includes(meal)
                    );
                    
                    const combinedData = {
                        ...mealTimeData,
                        allowedMeals: availableMeals,
                        dailyInfo: dailyData
                    };
                    
                    applyMealTimeRestrictions(combinedData);
                    updateMealTimeMessage(combinedData);
                }
            } catch (error) {
                console.error('Error loading meal time:', error);
            }
        }

        function applyMealTimeRestrictions(mealTimeData) {
            const mealTypeSelect = document.getElementById('mealType');
            if (!mealTypeSelect) return;
            
            // Clear existing options and rebuild
            mealTypeSelect.innerHTML = '<option value="">Select Meal Type</option>';
            
            // Add only allowed meals
            const mealOptions = {
                'breakfast': '🍳 Breakfast',
                'lunch': '🍽️ Lunch', 
                'dinner': '🍛 Dinner',
                'snacks': '🍪 Snacks'
            };
            
            mealTimeData.allowedMeals.forEach(mealType => {
                const option = document.createElement('option');
                option.value = mealType;
                option.textContent = mealOptions[mealType];
                mealTypeSelect.appendChild(option);
            });
            
            // Auto-select current meal if it's meal time
            if (mealTimeData.currentMeal !== 'none' && mealTimeData.allowedMeals.length === 1) {
                mealTypeSelect.value = mealTimeData.currentMeal;
            }
        }

        function updateMealTimeMessage(mealTimeData) {
            // Add or update meal time message in feedback section
            let messageDiv = document.getElementById('mealTimeMessage');
            
            if (!messageDiv) {
                messageDiv = document.createElement('div');
                messageDiv.id = 'mealTimeMessage';
                messageDiv.className = 'meal-time-message';
                
                const feedbackSection = document.getElementById('feedback');
                const firstChild = feedbackSection.querySelector('h2');
                firstChild.parentNode.insertBefore(messageDiv, firstChild.nextSibling);
            }
            
            let messageClass = 'info';
            let icon = 'fas fa-clock';
            
            if (mealTimeData.allowedMeals.length > 0) {
                messageClass = 'success';
                icon = 'fas fa-utensils';
            } else if (mealTimeData.dailyInfo && mealTimeData.dailyInfo.totalSubmissions >= 4) {
                messageClass = 'warning';
                icon = 'fas fa-check-circle';
            }
            
            let dailyInfo = '';
            if (mealTimeData.dailyInfo) {
                const submitted = mealTimeData.dailyInfo.submittedMeals || mealTimeData.dailyInfo.submitted_meals || [];
                const remaining = mealTimeData.dailyInfo.remainingMeals || mealTimeData.dailyInfo.remaining_meals || mealTimeData.dailyInfo.submitted_meals || [];
                
                // Ensure arrays
                const submittedArray = Array.isArray(submitted) ? submitted : [];
                const remainingArray = Array.isArray(remaining) ? remaining : [];
                
                dailyInfo = `
                    <br><strong>Today's Submissions:</strong> ${submittedArray.length}/4
                    ${submittedArray.length > 0 ? `<br><strong>Submitted:</strong> ${submittedArray.map(m => typeof m === 'string' ? m.charAt(0).toUpperCase() + m.slice(1) : m).join(', ')}` : ''}
                    ${remainingArray.length > 0 ? `<br><strong>Remaining:</strong> ${remainingArray.map(m => typeof m === 'string' ? m.charAt(0).toUpperCase() + m.slice(1) : m).join(', ')}` : '<br><strong>All meals submitted for today!</strong>'}
                `;
            }
            
            messageDiv.innerHTML = `
                <div class="alert alert-${messageClass}">
                    <i class="${icon}"></i>
                    <strong>Current Time:</strong> ${mealTimeData.currentTime}<br>
                    <strong>Meal Status:</strong> ${mealTimeData.timeMessage}
                    ${dailyInfo}
                </div>
            `;
        }

        // Mobile menu functionality
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.toggle('show');
            overlay.classList.toggle('show');
        }

        // Setup mobile menu event listeners
        document.getElementById('mobileMenuBtn').addEventListener('click', toggleMobileMenu);
        document.getElementById('sidebarOverlay').addEventListener('click', toggleMobileMenu);

        // Close sidebar when nav item is clicked on mobile
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    const sidebar = document.getElementById('sidebar');
                    const overlay = document.getElementById('sidebarOverlay');
                    sidebar.classList.remove('show');
                    overlay.classList.remove('show');
                }
            });
        });

        // Handle window resize
        window.addEventListener('resize', function() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (window.innerWidth > 768) {
                sidebar.classList.remove('show');
                overlay.classList.remove('show');
            }
        });

        // Close notification panel when clicking outside
        document.addEventListener('click', function(event) {
            const panel = document.getElementById('notificationPanel');
            const notificationNav = document.querySelector('.nav-item[onclick="toggleNotifications()"]');
            
            if (!panel.contains(event.target) && !notificationNav.contains(event.target)) {
                panel.classList.remove('show');
            }
        });

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/student-login';
        }

        // AI Chat Functions
        let aiConversationHistory = [];

        function toggleAIChat() {
            const panel = document.getElementById('aiChatPanel');
            panel.classList.toggle('show');
        }

        async function sendAIMessage() {
            const input = document.getElementById('aiChatInput');
            const message = input.value.trim();
            
            if (!message) return;

            const messagesContainer = document.getElementById('aiChatMessages');
            const statusDiv = document.getElementById('aiChatStatus');
            
            // Add user message to chat
            addMessageToChat('user', message);
            aiConversationHistory.push({ role: 'user', content: message });
            
            // Clear input
            input.value = '';
            
            // Show loading status
            statusDiv.textContent = 'AI is thinking...';
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/ai/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        message: message,
                        conversationHistory: aiConversationHistory
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    // Add AI response to chat
                    addMessageToChat('assistant', data.response);
                    aiConversationHistory.push({ role: 'assistant', content: data.response });
                    statusDiv.textContent = '';
                } else {
                    statusDiv.textContent = data.message || 'Failed to get response';
                    statusDiv.style.color = '#ff6b6b';
                }
            } catch (error) {
                console.error('Error sending AI message:', error);
                statusDiv.textContent = 'Error: Could not connect to AI service';
                statusDiv.style.color = '#ff6b6b';
            }
        }

        function addMessageToChat(role, content) {
            const messagesContainer = document.getElementById('aiChatMessages');
            
            // Remove welcome message if it exists
            const welcomeMsg = messagesContainer.querySelector('.text-center');
            if (welcomeMsg) {
                welcomeMsg.remove();
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                margin-bottom: 1rem;
                padding: 0.75rem 1rem;
                border-radius: 12px;
                ${role === 'user' 
                    ? 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin-left: 20%; text-align: right;' 
                    : 'background: rgba(255,255,255,0.15); margin-right: 20%; text-align: left;'}
                color: white;
                word-wrap: break-word;
            `;
            
            const icon = role === 'user' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';
            messageDiv.innerHTML = `
                <div style="font-size: 0.75rem; margin-bottom: 0.25rem; opacity: 0.8;">
                    ${icon} ${role === 'user' ? 'You' : 'AI Assistant'}
                </div>
                <div>${content}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Check AI service status on load
        async function checkAIStatus() {
            try {
                const response = await fetch('/api/ai/status');
                const data = await response.json();
                
                if (!data.configured) {
                    console.warn('AI service is not configured');
                    // Optionally hide AI assistant nav item
                    // document.querySelector('.nav-item[onclick="toggleAIChat()"]').style.display = 'none';
                }
            } catch (error) {
                console.error('Error checking AI status:', error);
            }
        }

        // Check AI status when page loads
        checkAIStatus();
    </script>
    
    <!-- Floating AI Assistant Button -->
    <button onclick="toggleAIChat()" style="
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        font-size: 28px;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        z-index: 1000;
        transition: all 0.3s ease;
    " onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
        <i class="fas fa-robot"></i>
    </button>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
